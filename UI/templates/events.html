<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All System Events</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Force refresh - cache buster */
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --dark-bg: #0f172a;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        [data-theme="dark"] {
            --light-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        body {
            background: linear-gradient(135deg, var(--light-bg) 0%, #f1f5f9 50%, #e2e8f0 100%);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1e293b 50%, #334155 100%);
        }

        /* Add subtle animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .navbar-glass { 
            backdrop-filter: saturate(140%) blur(10px); 
            background: rgba(20,24,42,.9); 
            border-bottom: 1px solid rgba(255,255,255,.08);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            width: 100%;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }
        .navbar-glass .navbar-brand, .navbar-glass .nav-link, .navbar-glass .btn { color: #e9ecef; }
        .navbar-glass .nav-link.active { color: #fff; font-weight: 600; }

        .status-card { 
            border: none; 
            box-shadow: var(--shadow); 
            border-radius: 24px; 
            background: var(--card-bg);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        }

        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .log-entry { 
            font-family: 'Courier New', monospace; 
            font-size: 0.9rem; 
            padding: 0.75rem 1rem; 
            border-left: 4px solid var(--border-color); 
            background: var(--card-bg); 
            border-radius: 12px; 
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .log-entry:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        .log-sensor { 
            border-left-color: var(--success-color); 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border-color: rgba(16, 185, 129, 0.2);
        }
        .log-error { 
            border-left-color: var(--danger-color); 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border-color: rgba(239, 68, 68, 0.2);
        }
        .log-data { 
            border-left-color: var(--warning-color); 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border-color: rgba(245, 158, 11, 0.2);
        }
        .controls .form-check { margin-right: 1rem; }
        .sticky-top-controls { 
            position: sticky; 
            top: 0; 
            z-index: 1020; 
            background: var(--card-bg); 
            padding-top: 0.75rem; 
            border-radius: 24px;
            backdrop-filter: blur(20px);
        }
        .nowrap { white-space: nowrap; }
        .badge-type { text-transform: uppercase; }
        
        /* AI Chat Styles */
        .ai-chat-container { height: 100%; display: flex; flex-direction: column; }
        .ai-status-bar { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 50%, var(--accent-color) 100%); 
            color: white; 
            padding: 1rem; 
            border-radius: 24px 24px 0 0; 
            margin: -1.5rem -1.5rem 1.5rem -1.5rem; 
            position: relative;
            overflow: hidden;
        }

        .ai-status-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
            animation: shimmer 3s ease-in-out infinite;
        }

        .ai-chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            max-height: 400px; 
            padding: 1rem; 
            background: var(--card-bg); 
            border-radius: 16px; 
            margin-bottom: 1rem; 
            border: 1px solid var(--border-color);
        }
        .ai-message { 
            margin-bottom: 0.75rem; 
            padding: 0.75rem; 
            border-radius: 12px; 
            background: var(--card-bg); 
            border-left: 3px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        .ai-message:hover {
            transform: translateX(2px);
            box-shadow: var(--shadow);
        }
        .ai-message.user { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); 
            border-left-color: var(--info-color); 
        }
        .ai-message.ai { 
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05)); 
            border-left-color: var(--secondary-color); 
        }
        .ai-message.error { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)); 
            border-left-color: var(--danger-color); 
        }
        .ai-message.loading { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05)); 
            border-left-color: var(--warning-color); 
        }
        .ai-input-group { margin-top: auto; }
        .ai-controls { margin-top: 1rem; }
        .ai-controls .btn { 
            font-size: 0.8rem; 
            padding: 0.5rem 1rem; 
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        /* AI Response Content Styling */
        .ai-response-content { 
            line-height: 1.5; 
            font-size: 0.9rem;
            white-space: pre-line;
        }
        .ai-response-content strong { 
            color: #2c3e50; 
            font-weight: 600; 
        }
        .ai-response-content em { 
            color: #7f8c8d; 
            font-style: italic; 
        }
        .ai-response-content code { 
            background-color: #ecf0f1; 
            padding: 0.2rem 0.4rem; 
            border-radius: 3px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.85rem; 
            color: #e74c3c; 
        }
        .ai-response-content br + br { 
            margin-top: 0.5rem; 
        }
        
        /* Responsive adjustments */
        @media (max-width: 991.98px) {
            .ai-chat-container { height: auto; min-height: 400px; }
            .ai-chat-messages { max-height: 250px; }
        }
        
        /* Enhanced buttons */
        .btn {
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        /* Theme toggle positioned lower */
        .theme-toggle {
            position: fixed;
            top: 500px;
            right: 20px;
            z-index: 1000;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        /* Dark mode fixes */
        [data-theme="dark"] .card-title {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .card-title i {
            color: var(--accent-color) !important;
        }

        [data-theme="dark"] .card-body p {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .card-body strong {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .card-body span {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .text-muted {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .text-muted i {
            color: var(--accent-color);
        }

        /* Analysis container dark mode fixes */
        [data-theme="dark"] #analysisContainer {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }

        [data-theme="dark"] #analysisContainer p {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] #analysisContainer .small {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #analysisContainer div {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] #analysisContainer .mb-2 {
            background: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] #analysisContainer .mb-2 .small {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #analysisContainer .mb-2 div {
            color: var(--text-primary) !important;
        }

        /* Override inline styles and Bootstrap classes */
        [data-theme="dark"] #analysisContainer .border {
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] #analysisContainer .bg-light {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] #analysisContainer .text-muted {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #analysisContainer .text-danger {
            color: var(--danger-color) !important;
        }

        /* Target all elements within analysis container */
        [data-theme="dark"] #analysisContainer * {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] #analysisContainer .small {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #analysisContainer .text-muted {
            color: var(--text-secondary) !important;
        }

        /* Force dark mode for analysis - most aggressive override */
        [data-theme="dark"] #analysisContainer,
        [data-theme="dark"] #analysisContainer div,
        [data-theme="dark"] #analysisContainer p,
        [data-theme="dark"] #analysisContainer span {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] #analysisContainer .small,
        [data-theme="dark"] #analysisContainer .text-muted {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] #analysisContainer .text-danger {
            color: #ef4444 !important;
        }

        [data-theme="dark"] #analysisContainer .border {
            border-color: #334155 !important;
        }

        /* Scrollbar styling */
        .ai-chat-messages::-webkit-scrollbar { width: 6px; }
        .ai-chat-messages::-webkit-scrollbar-track { background: var(--border-color); border-radius: 3px; }
        .ai-chat-messages::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 3px; }
        .ai-chat-messages::-webkit-scrollbar-thumb:hover { background: var(--text-primary); }

        /* Analysis container scrollbar */
        #analysisContainer::-webkit-scrollbar { width: 6px; }
        #analysisContainer::-webkit-scrollbar-track { background: var(--border-color); border-radius: 3px; }
        #analysisContainer::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 3px; }
        #analysisContainer::-webkit-scrollbar-thumb:hover { background: var(--text-primary); }
    </style>
    <link rel="icon" href="data:,">
    <!-- Prevent favicon 404s -->
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-glass">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="fas fa-thermometer-half me-2"></i>
                <strong>Temp Monitor</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navCollapse" aria-controls="navCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navCollapse">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" aria-current="page" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/events">Events</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Theme Toggle Button -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
        <i class="fas fa-moon" id="theme-icon"></i>
    </div>

    <div class="container-fluid py-3" style="margin-top: 80px;">
        <div class="row justify-content-center">
            <div class="col-xl-10 col-lg-11">
                <div class="status-card p-3 mb-3">
                    <div class="d-flex align-items-center justify-content-between flex-wrap">
                        <div class="mb-2">
                            <h3 class="mb-0"><i class="fas fa-stream me-2"></i>All System Events</h3>
                            <small class="text-muted">View and filter sensor, data, and error events</small>
                        </div>
                        <div class="mb-2">
                            <a href="/" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</a>
                        </div>
                    </div>
                </div>

                <div class="status-card p-3 sticky-top-controls">
                    <div class="row g-3 align-items-end controls">
                        <div class="col-md-4">
                            <label for="minutesInput" class="form-label">Time window (minutes)</label>
                            <div class="input-group">
                                <input type="number" min="0" max="1000000" step="1" class="form-control" id="minutesInput" value="0">
                                <button class="btn btn-outline-secondary" type="button" id="allTimeBtn" title="Show all events">All Time</button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search in text, component, type...">
                        </div>
                        <div class="col-md-4">
                            <div class="form-label">Types</div>
                            <div class="d-flex flex-wrap">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="sensor" id="filterSensor" checked>
                                    <label class="form-check-label" for="filterSensor">Sensor</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="data" id="filterData" checked>
                                    <label class="form-check-label" for="filterData">Data</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="error" id="filterError" checked>
                                    <label class="form-check-label" for="filterError">Error</label>
                                </div>
                                <div class="ms-auto nowrap">
                                    <button id="refreshBtn" class="btn btn-primary"><i class="fas fa-sync-alt me-1"></i> Refresh</button>
                                    <button id="forceRefreshBtn" class="btn btn-outline-warning btn-sm ms-2" title="Force refresh and clear cache"><i class="fas fa-redo me-1"></i> Force</button>
                                    <button id="checkCountBtn" class="btn btn-outline-info btn-sm ms-2" title="Check current log counts"><i class="fas fa-info-circle me-1"></i> Count</button>
                                    <button id="generateTestBtn" class="btn btn-outline-success btn-sm ms-2" title="Generate test events for today"><i class="fas fa-plus me-1"></i> Test Events</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-lg-5">
                        <div class="status-card p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="badge bg-secondary me-2" id="countBadge">0 events</span>
                                    <small class="text-muted">Last updated <span id="lastUpdated">never</span></small>
                                </div>
                                <div>
                                    <span class="badge bg-success me-1 badge-type" id="countSensor">0 SENSOR</span>
                                    <span class="badge bg-warning text-dark me-1 badge-type" id="countData">0 DATA</span>
                                    <span class="badge bg-danger badge-type" id="countError">0 ERROR</span>
                                </div>
                            </div>
                            <div id="eventsContainer" style="max-height: 70vh; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="status-card p-3 h-100">
                            <div class="ai-chat-container">
                                <div class="ai-status-bar">
                                    <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AI Assistant</h6>
                                    <div class="small opacity-75">
                                        <span id="aiMonitoring">Monitoring: Unknown</span> ·
                                        <span id="aiLastAnalysis">Last: Never</span> ·
                                        <span id="aiAlertCount">Alerts: 0</span>
                                    </div>
                                </div>
                                
                                <div id="recentAnalysis" class="mb-3">
                                    <h6 class="text-muted mb-2">Recent Analysis</h6>
                                    <div id="analysisContainer" style="max-height: 200px; overflow-y: auto; background-color: #1e293b !important; color: #f1f5f9 !important; border: 2px solid #ff0000 !important; border-radius: 8px; padding: 1rem;">
                                        <p class="small" style="color: #00ff00 !important; font-size: 16px !important; font-weight: bold !important;">TEST: Loading analysis...</p>
                                    </div>
                                </div>
                                
                                <div class="ai-chat-messages" id="chatMessages">
                                    <div class="ai-message ai">
                                        <div class="small text-muted">AI Assistant</div>
                                        <div>Hello! I can help analyze your system events. Ask me anything about the logs or start monitoring.</div>
                                    </div>
                                </div>
                                
                                <div class="ai-input-group">
                                    <div class="input-group">
                                        <input type="text" id="chatInput" class="form-control" placeholder="Ask about events, errors, or system status...">
                                        <button id="chatSend" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                                    </div>
                                </div>
                                
                                <div class="ai-controls">
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button id="btnStartAI" class="btn btn-success btn-sm">
                                            <i class="fas fa-play me-1"></i>Start
                                        </button>
                                        <button id="btnStopAI" class="btn btn-danger btn-sm">
                                            <i class="fas fa-stop me-1"></i>Stop
                                        </button>
                                        <button id="btnAnalyzeNow" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-search me-1"></i>Analyze
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawLogs = { sensor: [], data: [], error: [] };
        let chatHistory = [];

        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            
            // Force fix analysis container immediately
            setTimeout(() => {
                const analysisContainer = document.getElementById('analysisContainer');
                if (analysisContainer) {
                    analysisContainer.style.backgroundColor = '#1e293b';
                    analysisContainer.style.color = '#f1f5f9';
                    analysisContainer.style.borderColor = '#334155';
                    console.log('Analysis container styled:', analysisContainer.style.backgroundColor);
                }
            }, 50);
            
            document.getElementById('refreshBtn').addEventListener('click', loadLogs);
            document.getElementById('forceRefreshBtn').addEventListener('click', forceRefreshLogs);
            document.getElementById('checkCountBtn').addEventListener('click', checkLogCounts);
            document.getElementById('minutesInput').addEventListener('change', loadLogs);
            document.getElementById('searchInput').addEventListener('input', render);
            document.getElementById('filterSensor').addEventListener('change', render);
            document.getElementById('filterData').addEventListener('change', render);
            document.getElementById('filterError').addEventListener('change', render);
            document.getElementById('allTimeBtn').addEventListener('click', () => { document.getElementById('minutesInput').value = 0; loadLogs(); });
            
            // AI Chat event listeners
            document.getElementById('chatSend').addEventListener('click', sendChat);
            document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
            document.getElementById('btnStartAI').addEventListener('click', startAIMonitoring);
            document.getElementById('btnStopAI').addEventListener('click', stopAIMonitoring);
            document.getElementById('btnAnalyzeNow').addEventListener('click', triggerAnalysis);
            document.getElementById('generateTestBtn').addEventListener('click', generateTestEvents);
            
            loadLogs();
            loadAIStatus();
            loadRecentAnalysis();
            
            // Auto-refresh every 30 seconds
            setInterval(() => { 
                loadAIStatus(); 
                loadRecentAnalysis(); 
            }, 30000);
            
            // Auto-refresh logs every 30 seconds
            setInterval(() => { 
                loadLogs(); 
            }, 30000);
        });

        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Force apply dark mode styles to analysis container
            if (savedTheme === 'dark') {
                setTimeout(() => {
                    const analysisContainer = document.getElementById('analysisContainer');
                    if (analysisContainer) {
                        analysisContainer.style.backgroundColor = '#1e293b';
                        analysisContainer.style.color = '#f1f5f9';
                    }
                }, 100);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            // Force apply styles to analysis container
            setTimeout(() => {
                const analysisContainer = document.getElementById('analysisContainer');
                if (analysisContainer) {
                    if (newTheme === 'dark') {
                        analysisContainer.style.backgroundColor = '#1e293b';
                        analysisContainer.style.color = '#f1f5f9';
                        analysisContainer.style.borderColor = '#334155';
                    } else {
                        analysisContainer.style.backgroundColor = '#ffffff';
                        analysisContainer.style.color = '#1e293b';
                        analysisContainer.style.borderColor = '#e2e8f0';
                    }
                }
                // Reload analysis to apply new colors
                loadRecentAnalysis();
            }, 100);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        async function loadLogs() {
            const minutes = Math.max(0, parseInt(document.getElementById('minutesInput').value || '0', 10));  // Changed from '1440' to '0'
            const refreshBtn = document.getElementById('refreshBtn');
            
            // Show loading state
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
            
            try {
                console.log(`Refreshing logs with minutes=${minutes}`);
                const timestamp = Date.now(); // Cache buster
                const res = await fetch(`/api/logs?minutes=${encodeURIComponent(minutes)}&_t=${timestamp}`);
                const data = await res.json();
                if (data && data.success) {
                    rawLogs = data.logs || { sensor: [], data: [], error: [] };
                    const now = new Date().toLocaleString();
                    document.getElementById('lastUpdated').textContent = now;
                    console.log(`Loaded ${Object.values(rawLogs).reduce((sum, arr) => sum + arr.length, 0)} total events at ${now}`);
                    render();
                } else {
                    document.getElementById('eventsContainer').innerHTML = `<div class="alert alert-danger">Failed to load logs</div>`;
                }
            } catch (e) {
                document.getElementById('eventsContainer').innerHTML = `<div class="alert alert-danger">Error loading logs: ${e}</div>`;
                console.error('Error loading logs:', e);
            } finally {
                // Restore button state
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh';
            }
        }

        async function forceRefreshLogs() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';

            try {
                const timestamp = Date.now(); // Cache buster
                const res = await fetch(`/api/logs?minutes=0&_t=${timestamp}`); // Force all time
                const data = await res.json();
                if (data && data.success) {
                    rawLogs = data.logs || { sensor: [], data: [], error: [] };
                    const now = new Date().toLocaleString();
                    document.getElementById('lastUpdated').textContent = now;
                    console.log(`Forced refresh: Loaded ${Object.values(rawLogs).reduce((sum, arr) => sum + arr.length, 0)} total events at ${now}`);
                    render();
                } else {
                    document.getElementById('eventsContainer').innerHTML = `<div class="alert alert-danger">Failed to force refresh logs</div>`;
                }
            } catch (e) {
                document.getElementById('eventsContainer').innerHTML = `<div class="alert alert-danger">Error force refreshing logs: ${e}</div>`;
                console.error('Error force refreshing logs:', e);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh';
            }
        }

        function render() {
            const container = document.getElementById('eventsContainer');
            const search = (document.getElementById('searchInput').value || '').toLowerCase();
            const showSensor = document.getElementById('filterSensor').checked;
            const showData = document.getElementById('filterData').checked;
            const showError = document.getElementById('filterError').checked;

            const selectedTypes = [];
            if (showSensor) selectedTypes.push('sensor');
            if (showData) selectedTypes.push('data');
            if (showError) selectedTypes.push('error');
            
            // If nothing selected, show all
            if (selectedTypes.length === 0) {
                selectedTypes.push('sensor', 'data', 'error');
                // reflect in UI for clarity
                document.getElementById('filterSensor').checked = true;
                document.getElementById('filterData').checked = true;
                document.getElementById('filterError').checked = true;
            }

            let merged = [];
            for (const [type, list] of Object.entries(rawLogs)) {
                if (!selectedTypes.includes(type)) continue;
                for (const entry of list) {
                    merged.push({ type, ...entry });
                }
            }

            // Sort by timestamp desc if present
            merged.sort((a, b) => {
                let ta = 0, tb = 0;
                
                // Parse timestamps more robustly
                if (a.timestamp) {
                    try {
                        ta = new Date(a.timestamp).getTime();
                    } catch (e) {
                        // If parsing fails, try to extract numeric parts
                        const match = a.timestamp.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
                        if (match) {
                            ta = new Date(match[1], match[2]-1, match[3], match[4], match[5], match[6]).getTime();
                        }
                    }
                }
                
                if (b.timestamp) {
                    try {
                        tb = new Date(b.timestamp).getTime();
                    } catch (e) {
                        // If parsing fails, try to extract numeric parts
                        const match = b.timestamp.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
                        if (match) {
                            tb = new Date(match[1], match[2]-1, match[3], match[4], match[5], match[6]).getTime();
                        }
                    }
                }
                
                // Sort by timestamp descending (newest first)
                return tb - ta;
            });

            if (search) {
                merged = merged.filter(e => JSON.stringify(e).toLowerCase().includes(search));
            }

            // Update counts
            const counts = { sensor: 0, data: 0, error: 0 };
            merged.forEach(e => counts[e.type] = (counts[e.type] || 0) + 1);
            document.getElementById('countBadge').textContent = `${merged.length} events`;
            document.getElementById('countSensor').textContent = `${counts.sensor || 0} SENSOR`;
            document.getElementById('countData').textContent = `${counts.data || 0} DATA`;
            document.getElementById('countError').textContent = `${counts.error || 0} ERROR`;

            if (merged.length === 0) {
                container.innerHTML = '<p class="text-muted">No events match your filters.</p>';
                return;
            }

            const html = merged.map(renderEntry).join('');
            container.innerHTML = html;
        }

        function renderEntry(entry) {
            const t = sanitize(entry.type || '');
            const ts = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'Unknown';
            let summary = '';
            if (t === 'sensor') {
                summary = `${sanitize(entry.event_type || '')}: ${sanitize(entry.description || '')}`;
            } else if (t === 'error') {
                summary = `${sanitize(entry.component || '')}: ${sanitize(entry.error_message || '')}`;
            } else if (t === 'data') {
                summary = `${sanitize(entry.component || '')}.${sanitize(entry.event_type || '')}: ${sanitize(entry.description || '')}`;
            } else {
                summary = sanitize(JSON.stringify(entry));
            }
            const cls = t === 'sensor' ? 'log-sensor' : (t === 'error' ? 'log-error' : (t === 'data' ? 'log-data' : ''));
            return `
                <div class="log-entry ${cls} mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-bold">${ts}</div>
                            <div>${summary}</div>
                        </div>
                        <span class="badge badge-type ${badgeClass(t)}">${t.toUpperCase()}</span>
                    </div>
                    <details class="mt-2">
                        <summary class="text-muted">Details</summary>
                        <pre class="mb-0" style="white-space: pre-wrap;">${sanitize(JSON.stringify(entry, null, 2))}</pre>
                    </details>
                </div>
            `;
        }

        function sanitize(str) {
            return String(str).replace(/[&<>"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
        }

        function badgeClass(t) {
            if (t === 'sensor') return 'bg-success';
            if (t === 'error') return 'bg-danger';
            if (t === 'data') return 'bg-warning text-dark';
            return 'bg-secondary';
        }

        // AI Functions
        async function loadAIStatus() {
            try {
                const r = await fetch('/api/ai/status');
                const d = await r.json();
                if (d.success) {
                    const active = d.monitoring_active;
                    document.getElementById('aiMonitoring').textContent = `Monitoring: ${active ? 'Active' : 'Inactive'}`;
                    document.getElementById('aiLastAnalysis').textContent = `Last: ${d.last_analysis ? new Date(d.last_analysis).toLocaleString() : 'Never'}`;
                    document.getElementById('aiAlertCount').textContent = `Alerts: ${d.alert_count || 0}`;
                    
                    // Update button states
                    document.getElementById('btnStartAI').disabled = active;
                    document.getElementById('btnStopAI').disabled = !active;
                }
            } catch (e) {
                document.getElementById('aiMonitoring').textContent = 'Monitoring: Error';
            }
        }

        async function loadRecentAnalysis() {
            try {
                const r = await fetch('/api/ai/analysis');
                const d = await r.json();
                const container = document.getElementById('analysisContainer');
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                
                if (d.success && d.recent_alerts && d.recent_alerts.length) {
                    const html = d.recent_alerts.map(a => {
                        const ts = new Date(a.timestamp).toLocaleString();
                        const text = (a.analysis || '').replace(/\n/g, '<br>');
                        const bgColor = isDark ? '#1e293b' : '#ffffff';
                        const textColor = isDark ? '#f1f5f9' : '#1e293b';
                        const secondaryColor = isDark ? '#94a3b8' : '#64748b';
                        const borderColor = isDark ? '#334155' : '#e2e8f0';
                        
                        return `<div class="mb-2 p-2 border rounded" style="background: ${bgColor}; border-color: ${borderColor}; color: ${textColor};"><div class="small" style="color: ${secondaryColor};">${ts}</div><div style="white-space:pre-wrap; font-size: 0.85rem; color: ${textColor};">${text}</div></div>`;
                    }).join('');
                    container.innerHTML = html;
                } else {
                    const textColor = isDark ? '#94a3b8' : '#64748b';
                    container.innerHTML = `<p class="small" style="color: ${textColor};">No recent analysis</p>`;
                }
            } catch (e) {
                const errorColor = isDark ? '#ef4444' : '#dc3545';
                document.getElementById('analysisContainer').innerHTML = `<p class="small" style="color: ${errorColor};">Error loading analysis</p>`;
            }
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            // Add user message
            addChatMessage('user', msg);
            input.value = '';
            
            // Add loading message
            const loadingId = addChatMessage('loading', 'Thinking...');
            
            try {
                const r = await fetch('/api/ai/chat', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({ message: msg })
                });
                const d = await r.json();
                
                if (d.success) {
                    replaceChatMessage(loadingId, 'ai', d.ai_response || 'No response');
                } else {
                    replaceChatMessage(loadingId, 'error', d.error || 'Error occurred');
                }
            } catch (e) {
                replaceChatMessage(loadingId, 'error', e.message);
            }
        }

        function addChatMessage(type, content) {
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            const msgId = 'msg-' + Date.now();
            msgDiv.id = msgId;
            msgDiv.className = `ai-message ${type}`;
            
            const sender = type === 'user' ? 'You' : (type === 'ai' ? 'AI Assistant' : 'System');
            msgDiv.innerHTML = `<div class="small text-muted">${sender}</div><div>${sanitize(content)}</div>`;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            
            return msgId;
        }

        function replaceChatMessage(msgId, type, content) {
            const msgDiv = document.getElementById(msgId);
            if (msgDiv) {
                const sender = type === 'user' ? 'You' : (type === 'ai' ? 'AI Assistant' : 'System');
                msgDiv.className = `ai-message ${type}`;
                
                // Format AI responses with proper HTML formatting
                let formattedContent = content;
                if (type === 'ai') {
                    // Convert markdown-style formatting to HTML
                    formattedContent = formatAIResponse(content);
                }
                
                msgDiv.innerHTML = `<div class="small text-muted">${sender}</div><div class="ai-response-content">${formattedContent}</div>`;
            }
        }

        function formatAIResponse(text) {
            if (!text) return '';
            
            // Replace line breaks with <br> tags
            let formatted = text.replace(/\n/g, '<br>');
            
            // Format **bold** text
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Format *italic* text
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Format bullet points
            formatted = formatted.replace(/^\s*•\s*/gm, '• ');
            formatted = formatted.replace(/^\s*-\s*/gm, '• ');
            
            // Format numbered lists
            formatted = formatted.replace(/^\s*(\d+)\.\s*/gm, '$1. ');
            
            // Add spacing around sections
            formatted = formatted.replace(/(<br>)([A-Z][^<]*:)/g, '$1<br><br><strong>$2</strong>');
            
            // Format code blocks (simple)
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-light px-1 rounded">$1</code>');
            
            return formatted;
        }

        async function startAIMonitoring() {
            try {
                await fetch('/api/ai/start-monitoring', {method: 'POST'});
                loadAIStatus();
                addChatMessage('ai', 'AI monitoring started successfully!');
            } catch (e) {
                addChatMessage('error', `Failed to start monitoring: ${e.message}`);
            }
        }

        async function stopAIMonitoring() {
            try {
                await fetch('/api/ai/stop-monitoring', {method: 'POST'});
                loadAIStatus();
                addChatMessage('ai', 'AI monitoring stopped successfully!');
            } catch (e) {
                addChatMessage('error', `Failed to stop monitoring: ${e.message}`);
            }
        }

        async function triggerAnalysis() {
            try {
                await fetch('/api/ai/analyze', {method: 'POST'});
                addChatMessage('ai', 'Analysis triggered! Results will appear above shortly.');
                setTimeout(loadRecentAnalysis, 2000);
            } catch (e) {
                addChatMessage('error', `Failed to trigger analysis: ${e.message}`);
            }
        }

        async function generateTestEvents() {
            try {
                const now = new Date();
                const today = now.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // Create test events for today
                const testEvents = [
                    {
                        timestamp: new Date().toISOString(),
                        type: 'sensor',
                        event_type: 'test_temperature',
                        description: `Test temperature reading: ${(20 + Math.random() * 10).toFixed(1)}°C`
                    },
                    {
                        timestamp: new Date(Date.now() - 60000).toISOString(), // 1 minute ago
                        type: 'data',
                        component: 'test',
                        event_type: 'data_generated',
                        description: 'Test data event generated for today'
                    },
                    {
                        timestamp: new Date(Date.now() - 120000).toISOString(), // 2 minutes ago
                        type: 'error',
                        component: 'test',
                        error_message: 'Simulated test error for demonstration'
                    }
                ];

                // Add to rawLogs
                testEvents.forEach(event => {
                    if (event.type === 'sensor') rawLogs.sensor.unshift(event);
                    else if (event.type === 'data') rawLogs.data.unshift(event);
                    else if (event.type === 'error') rawLogs.error.unshift(event);
                });

                // Re-render
                render();
                addChatMessage('ai', `Generated ${testEvents.length} test events for today!`);
                
            } catch (e) {
                addChatMessage('error', `Failed to generate test events: ${e.message}`);
            }
        }

        async function checkLogCounts() {
            try {
                const r = await fetch('/api/logs/counts');
                const d = await r.json();
                if (d.success) {
                    const sensorCount = d.sensor_count || 0;
                    const dataCount = d.data_count || 0;
                    const errorCount = d.error_count || 0;

                    document.getElementById('countSensor').textContent = `${sensorCount} SENSOR`;
                    document.getElementById('countData').textContent = `${dataCount} DATA`;
                    document.getElementById('countError').textContent = `${errorCount} ERROR`;
                    document.getElementById('countBadge').textContent = `${sensorCount + dataCount + errorCount} total events`;
                    addChatMessage('ai', `Current log counts: SENSOR=${sensorCount}, DATA=${dataCount}, ERROR=${errorCount}`);
                } else {
                    addChatMessage('error', `Failed to check log counts: ${d.error || 'Unknown error'}`);
                }
            } catch (e) {
                addChatMessage('error', `Error checking log counts: ${e.message}`);
                console.error('Error checking log counts:', e);
            }
        }
    </script>
</body>
</html>


